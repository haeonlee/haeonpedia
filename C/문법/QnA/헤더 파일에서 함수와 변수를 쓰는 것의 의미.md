작성일: 2022. 08. 14

책 <혼자 공부하는 C언어>에서 헤더 파일에 대해 공부하다가 '초기화된 전역 변수의 선언은 헤더 파일이 여러 파일에 인클루드되었을 때 전역 변수의 중복 문제가 발생합니다.'라는 말에 뜻을 정확히 이해하고 싶어져서 이 글을 씁니다.

---

참고자료
- [헤더파일에 static 선언을 하면 안 되는 이유](https://thrillfighter.tistory.com/257)
- [c,c++ 헤더 파일에 전역변수 선언하기](https://blog.naver.com/PostView.naver?blogId=phh0606c&logNo=10174041285&redirect=Dlog&widgetTypeCall=true&directAccess=false)
- 전역변수 - extern 사용법(https://muyu.tistory.com/entry/전역변수-extern-사용법)
--- 

# 헤더파일 속 함수와 변수

    함수 선언(void func();)와 변수 선언(int a;)는 근본적으로 다른 선언입니다.

        (1) 함수 선언: void func()는 func()가 프로그램 어디에 있다고 말하는 표시등입니다.
        (2) 변수 선언: int a라고 하면 데이터 영역에 a에 쓰여집니다.

    이런 차이로 인해서 헤더파일에 변수 선언이 있다면, 헤더파일이 불려지는 횟수만큼 중복 선언이 발생합니다.
    
# 헤더파일 변수 선언법: extern

    헤더 파일에서는 변수를 extern으로 선언하세요.

    예를 들어
        a.h에 extern int a;
        b.h에 extern int b;
        가 선언돼 있다고 합시다.

        그렇다면 main.c 파일에서
            int a;
            int b;
        파일로 정의하세요.
        
        그리고 sub.c 파일에서는 a.h와 b.h 등 파일을 인클루드하면 됩니다.
            

    컴파일러는 extern을 보면 "extern이 있다는 것은, 얜 어디 다른 곳에 정의돼 있다는 뜻이니까 그걸 데리고 오자."라고 생각하며 무시해 버립니다. 그렇기에 헤더 파일에 정의한 a라는 변수를 여러 곳에서 사용할 수 있는 셈입니다.


[출처] c,c++ 헤더 파일에 전역변수 선언하기|작성자 통통 브라운





a.h 와 b.h를 main.cpp 에서 include 하면 이 경우는 초기화가 되는 것이 아니므로 제대로 수행이 된다.

경우에 따라 다르겠지만, 선택은 사용자의 몫..

그러면 static에 대해서 알아보자. 흔히 잘못 알고 있는 프로그래밍 상식 중 하나가 이 static 함수나 변수의 헤더파일에서의 사용이라고 생각한다.

만약a,b각 모듈을 만든 회사가 동일한 함수명을 사용하여 충돌이 발생된다면?

"이 경우는 static으로 선언하면 된다." 라고 많은 책이나 문서에 설명되어 있지만. 정확히 말하면 cpp파일에 static으로 정의해야 한다. 필자는 경험적으로 배운 사실이므로 이를 증명할 수 있는 건 필자의 경험 뿐이다.(믿거나 말거나).

아무튼 이 static의 다형적인 특성 때문에 안 그래도 헷갈리는 static!, 간단한 예로 왜 static을 헤더에 사용하지 말아야 하는지 설명하겠다.



2015/06/18 - [프로그래밍/C언어] - 지역변수와 전역변수와 정적변수[static, extern, auto, register]

2015/06/18 - [프로그래밍/C언어] - 전역 변수를 지역변수로 만들면? (static과 extern에 대한 이야기)

지난번 설명한 번역단위를 떠올리자. a모듈과 b모듈에서 동일한 명의 함수가 존재한다고 하자. 사용자는 두 개의 모듈이 모두 필요하고, 동일한 명의 함수 중 하나의 함수만 사용하길 원한다. b모듈의 test()함수만 사용하고 a모듈의 test()함수는 사용하지 않을 예정이다.

위 문제를 해결하기 위해서 a.h의 선언부분에 가서 test()함수를 static으로 만들면?

한번 따져보자 main.cpp에 다음과 같은 두 개의 문장이 추가될 것이다.

static void test();

void test();

위 두 문장을 가볍게 넘기면 안 된다. 만약 하나의 모듈을 만들 때 위와 같이 선언한다면? 누가 봐도 에러가 생긴다는 것을 알 수 있다.

이에 대해서 따지다 보면 대단히 머리가 아파옴을 알 수 있다. 굳이 따지자면

static void test(); // 이 선언은 a의 모듈의 함수를 위한 것이지만, main에서는 그냥 문자 그대로를 해석하기 때문에, 자신의 모듈에서 static으로 선언된 것으로 인식한다. 실제로 main에서 test()함수에 대한 정의를 하게 되면 제대로 수행된다. void test();의 경우는 내부적으로 어떻게 동작하는지는 잘 모르지만 에러를 발생시키지 않는다. 아무튼 위 방식대로 라면 모듈의 test()함수는 사용하지 못하여 의미가 없게 된다.

여기서 include 순서를 바꿔보면

void test();

static void test();

이 경우는 extern 으로 선언한 함수를 static으로 다시 선언하면 안 된다고 에러가 뜬다. 심지어 include 순서까지 영향을 준다. 그래서 이에 대해서 논하는 것은 그렇게 가치있는 일이 아니다. 결론은 헤더파일에 static을 사용하지 않으면 해결될 문제고, 이런 지침을 따르기만 하면 된다.

.c 또는 .cpp 파일에 static함수를 정의하면 된다.

제대로 된 설계를 하기 위해서는 헤더파일에는 함수의 선언만, 각 모듈간에는 함수명이 충돌하지 않도록 해야 한다.